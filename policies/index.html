



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Getting started with cloud native security">
      
      
      
        <meta name="author" content="Liz Rice and Michael Hausenblas">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.4.0">
    
    
      
        <title>Policies - Cloud Native Security Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700|PT+Mono&display=fallback">
        <style>body,input{font-family:"Lato","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"PT Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#policies" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Cloud Native Security Tutorial" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Cloud Native Security Tutorial
            </span>
            <span class="md-header-nav__topic">
              
                Policies
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/k8s-sec/cloud-native-security-tutorial/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    k8s-sec/cloud-native-security-tutorial
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Cloud Native Security Tutorial" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Cloud Native Security Tutorial
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/k8s-sec/cloud-native-security-tutorial/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    k8s-sec/cloud-native-security-tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../preparation/" title="Preparation" class="md-nav__link">
      Preparation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Exercises
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../compromise/" title="Compromised pod" class="md-nav__link">
      Compromised pod
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../scanning/" title="Scanning" class="md-nav__link">
      Scanning
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Policies
      </label>
    
    <a href="./" title="Policies" class="md-nav__link md-nav__link--active">
      Policies
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#least-privileges" title="Least privileges" class="md-nav__link">
    Least privileges
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation" title="Preparation" class="md-nav__link">
    Preparation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-security-context" title="Using a security context" class="md-nav__link">
    Using a security context
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-policies" title="Network policies" class="md-nav__link">
    Network policies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation_1" title="Preparation" class="md-nav__link">
    Preparation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-ingress-traffic" title="Limit ingress traffic" class="md-nav__link">
    Limit ingress traffic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-purpose-policies" title="General purpose policies" class="md-nav__link">
    General purpose policies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opa-in-action" title="OPA in action" class="md-nav__link">
    OPA in action
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-gatekeeper" title="OPA Gatekeeper" class="md-nav__link">
    OPA Gatekeeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../settings/" title="Secure settings" class="md-nav__link">
      Secure settings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gitops/" title="GitOps" class="md-nav__link">
      GitOps
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Conclusion
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Conclusion
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../conclusions/" title="Conclusions" class="md-nav__link">
      Conclusions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#least-privileges" title="Least privileges" class="md-nav__link">
    Least privileges
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation" title="Preparation" class="md-nav__link">
    Preparation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-security-context" title="Using a security context" class="md-nav__link">
    Using a security context
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-policies" title="Network policies" class="md-nav__link">
    Network policies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation_1" title="Preparation" class="md-nav__link">
    Preparation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-ingress-traffic" title="Limit ingress traffic" class="md-nav__link">
    Limit ingress traffic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-purpose-policies" title="General purpose policies" class="md-nav__link">
    General purpose policies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opa-in-action" title="OPA in action" class="md-nav__link">
    OPA in action
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-gatekeeper" title="OPA Gatekeeper" class="md-nav__link">
    OPA Gatekeeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/k8s-sec/cloud-native-security-tutorial/edit/master/docs/policies.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="policies">Policies<a class="headerlink" href="#policies" title="Permanent link">&para;</a></h1>
<p>One important tool in the defense in depth strategy are policies. These define
what is or is not allowed and part of it is usually an enforcement component.
In this section we will have a look at a number of different policies and how
you can apply them.</p>
<p>In the context of policies, the concept of least privileges is an important one,
so let's have a look at this for starters.</p>
<h2 id="least-privileges">Least privileges<a class="headerlink" href="#least-privileges" title="Permanent link">&para;</a></h2>
<p>With least privileges we mean to equip someone or something with exactly the
rights to carry out their or its task but not more. For example, if you consider
a program that needs to read from a specific location in the filesystem then
the operation (<code>read</code>) and the location (say, <code>/data</code>) would determine what
permissions are necessary. Conversely, said program would <em>not</em> need <code>write</code> access
in addition and hence this would violate the least privileges principle.</p>
<p>First off we start with the simple case of a Kubernetes security context, 
allowing you to specify runtime policies around privileges and access control.</p>
<h3 id="preparation">Preparation<a class="headerlink" href="#preparation" title="Permanent link">&para;</a></h3>
<p>Let's create the cluster for it:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kind create cluster --name cnsectut \</span>
<span class="err">     --config res/security-context-cluster-config.yaml</span>
</code></pre></div>
</td></tr></table>

<h3 id="using-a-security-context">Using a security context<a class="headerlink" href="#using-a-security-context" title="Permanent link">&para;</a></h3>
<p>We will be using an <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">example from the Kubernetes docs</a>
so that you can read up on the details later on. </p>
<p>First, launch the <a href="https://github.com/k8s-sec/cloud-native-security-tutorial/blob/master/res/pod-security-context.yaml">pod with a security context</a> defined like so:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://raw.githubusercontent.com/k8s-sec/cloud-native-security-tutorial/master/res/pod-security-context.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Next, enter the pod:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl exec -it security-context -- sh</span>
</code></pre></div>
</td></tr></table>

<p>And, in the pod, create a file as shown:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">echo something &gt; /data/content ; cd /data &amp;&amp; id</span>
</code></pre></div>
</td></tr></table>

<p>What you see here is how the security context defined in the pod enforces file
and group ownership. But who enforces the definition of security contexts? That
is, how can you make sure that a developer creating a pod spec in fact thinks
of this? Enter <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security
Policies</a> or
PSP for short.</p>
<p>Learn more about least privileges practices in the container runtime context via:</p>
<ul>
<li><a href="https://rootlesscontaine.rs/">rootlesscontaine.rs</a></li>
<li><a href="http://canihaznonprivilegedcontainers.info/">canihaznonprivilegedcontainers.info</a></li>
<li><a href="https://jaosorior.dev/2019/selinux-as-a-resource-in-kubernetes/">SELinux as a resource in Kubernetes</a></li>
<li><a href="https://github.com/kubernetes-sigs/seccomp-operator">kubernetes-sigs/seccomp-operator</a></li>
<li><a href="https://itnext.io/seccomp-in-kubernetes-part-i-7-things-you-should-know-before-you-even-start-97502ad6b6d6">Seccomp in Kubernetes</a></li>
</ul>
<p>Clean up with <code>kind delete cluster --name cnsectut</code> when you're done exploring
this topic.</p>
<h2 id="network-policies">Network policies<a class="headerlink" href="#network-policies" title="Permanent link">&para;</a></h2>
<p>So runtime policies are fun, but not the only thing that matters: next up, we
have a look at network policies. These kind of policies allow you to control
the communication patterns in-cluster (between pods) and concerning the outside
world (ingress and egress traffic):</p>
<p><img alt="Kubernetes networking overview" src="../img/kube-networking.png" /></p>
<p>You might be surprised to learn that in Kubernetes by default all traffic
(in-cluster and to/from the outside world) is allowed. That is, any pod can see
and talk to any other pod by default as well as any connection to a pod running in your
Kubernetes cluster.</p>
<h3 id="preparation_1">Preparation<a class="headerlink" href="#preparation_1" title="Permanent link">&para;</a></h3>
<p>Let's create the cluster for the network policies walkthrough. </p>
<p>The following can take a minute or two, depending on if you've pulled the
container images before or doing it the first time (then it can take 10min or more):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kind create cluster --name cnnp --config res/network-policy-cluster-config.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Next, install the Calico controller and custom resources
(this is the CNI plugin that allows us to enforce the network policies):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Then, we need to patch the setup due to the fact we're using <code>kind</code> here 
(kudos to <a href="https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/">Alex</a>
for the patch instructions):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl -n kube-system set env daemonset/calico-node FELIX_IGNORELOOSERPF=true</span>
</code></pre></div>
</td></tr></table>

<p>Now you can verify the setup, and note that it can take some 5 min until 
you see all pods in the <code>Running</code> state:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl -n kube-system get pods | grep calico-node</span>
</code></pre></div>
</td></tr></table>

<p>Last but not least we install <a href="https://www.getambassador.io/">Ambassador</a> as an
ingress controller so that we can access to workloads from outside of the cluster:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://github.com/datawire/ambassador-operator/releases/latest/download/ambassador-operator-crds.yaml &amp;&amp; \</span>
<span class="err">kubectl apply -n ambassador -f https://github.com/datawire/ambassador-operator/releases/latest/download/ambassador-operator-kind.yaml &amp;&amp; \</span>
<span class="err">kubectl wait --timeout=180s -n ambassador --for=condition=deployed ambassadorinstallations/ambassador</span>
</code></pre></div>
</td></tr></table>

<p>And with that we're ready to apply some network policies.</p>
<h3 id="limit-ingress-traffic">Limit ingress traffic<a class="headerlink" href="#limit-ingress-traffic" title="Permanent link">&para;</a></h3>
<p>Now let's see network policies in action by creating a public-facing workload
and define the communication paths.</p>
<p>First off, we want to do all of the following in a dedicated namespace called
<code>npdemo</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl create ns npdemo</span>
</code></pre></div>
</td></tr></table>

<p>Now, create the workload (deployment, service, ingress):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl -n npdemo apply -f res/np-workload.yaml</span>
</code></pre></div>
</td></tr></table>

<p>When you now query the endpoint defined by the <a href="https://github.com/k8s-sec/cloud-native-security-tutorial/blob/b5efb0ee54fbb3ded4f5cac8d7834f1e59881948/res/np-workload.yaml#L33">ingress resource</a>
you deployed in the previous step you will find that it works as expected
(remember: by default, all is allowed/open):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">curl localhost/api</span>
</code></pre></div>
</td></tr></table>

<p>Now we shut down all traffic with:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl -n npdemo apply -f res/deny-all.yaml</span>
</code></pre></div>
</td></tr></table>

<p>And try again:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">curl localhost/api</span>
</code></pre></div>
</td></tr></table>

<p>As we'd have hoped and expected the access is now denied (might need to give it
a second or so until the change is picked up).</p>
<p>But now, how do we allow traffic to the frontend (represented by the NGINX web
server)? Well, we define another network policy that allows ingress to stuff
labelled with <code>role=frontend</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl -n npdemo apply -f res/allow-frontend.yaml &amp;&amp; \</span>
<span class="err">kubectl -n npdemo label pods --selector=app=nginx role=frontend</span>
</code></pre></div>
</td></tr></table>

<p>And now it should work again:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">curl localhost/api</span>
</code></pre></div>
</td></tr></table>

<p>Learn more about network policies via:</p>
<ul>
<li><a href="https://banzaicloud.com/blog/network-policy/">Exploring Network Policies in Kubernetes</a></li>
<li><a href="https://medium.com/@tufin/best-practices-for-kubernetes-network-policies-2b643c4b1aa">Best Practices for Kubernetes Network Policies</a></li>
<li><a href="https://ahmet.im/blog/kubernetes-network-policy/">Securing Kubernetes Cluster Networking</a></li>
</ul>
<p>Clean up with <code>kind delete cluster --name cnnp</code> when you're done exploring
this topic.</p>
<h2 id="general-purpose-policies">General purpose policies<a class="headerlink" href="#general-purpose-policies" title="Permanent link">&para;</a></h2>
<p>We have now seen container runtime policies as well as network policies in
action. You should by now have an idea what policies are and how to go about
defining and enforcing them. But did you notice one thing: for every type of 
policy, we had a different mechanism (and mind you, we only had a look at two 
types). Also, when you want to introduce further policies, for example, company
ones or maybe stuff you need to do to be compliant with some regulatory
framework such as PCI DSS. How do you deal with this in the context of
containers?</p>
<p>Meet the CNCF <a href="https://www.openpolicyagent.org/">Open Policy Agent</a> (OPA) project.</p>
<p>OPA (pronounced "oh-pa") is a general-purpose policy engine that comes with a powerful rule-based
policy language called Rego (pronounced "ray-go"). Rego takes any kind of JSON
data as input and matches against a set of rules. It also comes with a long list
of <a href="https://www.openpolicyagent.org/docs/latest/policy-reference/#built-in-functions">built-in</a>
functions, with from simple string manipulation stuff like
<code>strings.replace_n(patterns, string)</code> to fancy things such as
<code>crypto.x509.parse_certificates(string)</code>.</p>
<p>Enough theory, let's jump into the deep end using the <a href="https://play.openpolicyagent.org/">OPA Rego
playground</a>.</p>
<h3 id="opa-in-action">OPA in action<a class="headerlink" href="#opa-in-action" title="Permanent link">&para;</a></h3>
<p>Let's say you have the following input data, which is an array of timestamped
entries:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">[</span>
<span class="err">    {</span>
<span class="err">        &quot;msg&quot;: &quot;within a week&quot;,</span>
<span class="err">        &quot;timestamp&quot;: &quot;2020-03-27T12:00:00Z&quot;</span>
<span class="err">    },</span>
<span class="err">    {</span>
<span class="err">        &quot;msg&quot;: &quot;same year&quot;,</span>
<span class="err">        &quot;timestamp&quot;: &quot;2020-10-09T12:00:00Z&quot;</span>
<span class="err">    },</span>
<span class="err">    {</span>
<span class="err">        &quot;msg&quot;: &quot;last year&quot;,</span>
<span class="err">        &quot;timestamp&quot;: &quot;2019-12-24T12:00:00Z&quot;</span>
<span class="err">    }</span>
<span class="err">]</span>
</code></pre></div>
</td></tr></table>

<p>So how can we check if a given entry is within a certain time window?
For example, you might require that a certain commit is not older than a week.</p>
<p>The following Rego file defines the policy we want to enforce (with a fixed
point in time <code>2020-04-01T12:00:00Z</code> as a reference):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">play</span><span class="w"></span>

<span class="n">ts_reference</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="n">parse_rfc3339_ns</span><span class="p">(</span><span class="ss">&quot;2020-04-01T12:00:00Z&quot;</span><span class="p">)</span><span class="w"></span>

<span class="n">time_window_check</span><span class="o">[</span><span class="n">results</span><span class="o">]</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="ow">some</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">  </span><span class="n">msg</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="k">input</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">msg</span><span class="w"></span>
<span class="w">  </span><span class="n">ts</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="n">parse_rfc3339_ns</span><span class="p">(</span><span class="k">input</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="nc">timestamp</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">results</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;same_year&quot;</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">same_year</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;within_a_week&quot;</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">within_a_week</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="ss">&quot;message&quot;</span><span class="err">:</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">same_year</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="o">[</span><span class="n">c_y, c_m, c_d</span><span class="o">]</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="nc">date</span><span class="p">(</span><span class="n">ts_reference</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">[</span><span class="n">ts_y, ts_m, ts_d</span><span class="o">]</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="nc">date</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">ts_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c_y</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">within_a_week</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">a_week</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">  </span><span class="n">diff</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">ts_reference</span><span class="o">/</span><span class="mi">1000</span><span class="o">/</span><span class="mi">1000</span><span class="o">/</span><span class="mi">1000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="o">/</span><span class="mi">1000</span><span class="o">/</span><span class="mi">1000</span><span class="o">/</span><span class="mi">1000</span><span class="w"></span>
<span class="w">  </span><span class="n">diff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a_week</span><span class="w"></span>
<span class="w">  </span><span class="n">ts_reference</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ts</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>Applying above Rego rule set to the input data, that is, querying for 
<code>time_window_check[results]</code> yields:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">Found 1 result in 872.098 µs.</span>
<span class="err">{</span>
<span class="err">    &quot;time_window_check&quot;: [</span>
<span class="err">        {</span>
<span class="err">            &quot;message&quot;: &quot;within a week&quot;,</span>
<span class="err">            &quot;same_year&quot;: true,</span>
<span class="err">            &quot;within_a_week&quot;: true</span>
<span class="err">        }</span>
<span class="err">    ],</span>
<span class="err">    &quot;ts_reference&quot;: 1585742400000000000</span>
<span class="err">}</span>
</code></pre></div>
</td></tr></table>

<p>You can try this online yourself via the <a href="https://play.openpolicyagent.org/p/6v2EfFSq3l">prepared playground example</a>.</p>
<h3 id="opa-gatekeeper">OPA Gatekeeper<a class="headerlink" href="#opa-gatekeeper" title="Permanent link">&para;</a></h3>
<p>Now that you have an idea what OPA and Rego is you might wonder how hard it is
to use OPA/Rego in the context of Kubernetes. Turns out that writing, testing,
and enforcing these Rego rules is relatively hard and something that you don't
want to push onto individual folks. Good news is that the community came together 
to tackle this problem in the form of the <a href="https://github.com/open-policy-agent/gatekeeper">Gatekeeper</a> project.</p>
<p>The Gatekeeper project solves the challenge of having to write and enforce Rego
rules by using the Kubernetes-native extension points of custom resources and
<a href="https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/">dynamic admission control</a>.</p>
<p>As an end-user it's as simple as follows to use OPA with Gatekeeper. After
installing Gatekeeper, define and apply a custom resource like the following:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span> <span class="n">constraints</span><span class="o">.</span><span class="na">gatekeeper</span><span class="o">.</span><span class="na">sh</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">K8sRequiredLabels</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">test</span><span class="o">-</span><span class="n">ns</span><span class="o">-</span><span class="n">label</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">match</span><span class="o">:</span>
    <span class="n">kinds</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">apiGroups</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">]</span>
        <span class="n">kinds</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;Namespace&quot;</span><span class="o">]</span>
  <span class="n">parameters</span><span class="o">:</span>
    <span class="n">labels</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="o">]</span>
</code></pre></div>
</td></tr></table>

<p>This constraint above requires that all namespaces MUST have a label <code>test</code>.</p>
<p>But where is the Rego rule set I hear you ask?</p>
<p>Gatekeeper employs a separation of duties approach where (someone other than the
end-user) defines a template like so:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nl">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="n">gatekeeper</span><span class="p">.</span><span class="n">sh</span><span class="o">/</span><span class="n">v1beta1</span><span class="w"></span>
<span class="nl">kind</span><span class="p">:</span><span class="w"> </span><span class="n">ConstraintTemplate</span><span class="w"></span>
<span class="nl">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">k8srequiredlabels</span><span class="w"></span>
<span class="nl">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nl">crd</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nl">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">names</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="nl">kind</span><span class="p">:</span><span class="w"> </span><span class="n">K8sRequiredLabels</span><span class="w"></span>
<span class="w">        </span><span class="nl">listKind</span><span class="p">:</span><span class="w"> </span><span class="n">K8sRequiredLabelsList</span><span class="w"></span>
<span class="w">        </span><span class="nl">plural</span><span class="p">:</span><span class="w"> </span><span class="n">k8srequiredlabels</span><span class="w"></span>
<span class="w">        </span><span class="nl">singular</span><span class="p">:</span><span class="w"> </span><span class="n">k8srequiredlabels</span><span class="w"></span>
<span class="w">      </span><span class="nl">validation</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Schema</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="k">parameters</span><span class="err">`</span><span class="w"> </span><span class="n">field</span><span class="w"></span>
<span class="w">        </span><span class="nl">openAPIV3Schema</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nl">properties</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nl">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">array</span><span class="w"></span>
<span class="w">              </span><span class="nl">items</span><span class="p">:</span><span class="w"> </span><span class="n">string</span><span class="w"></span>
<span class="w">  </span><span class="nl">targets</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nl">target</span><span class="p">:</span><span class="w"> </span><span class="n">admission</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">gatekeeper</span><span class="p">.</span><span class="n">sh</span><span class="w"></span>
<span class="w">      </span><span class="nl">rego</span><span class="p">:</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="n">package</span><span class="w"> </span><span class="n">k8srequiredlabels</span><span class="w"></span>

<span class="w">        </span><span class="n">violation</span><span class="o">[</span><span class="n">{&quot;msg&quot;: msg, &quot;details&quot;: {&quot;missing_labels&quot;: missing}}</span><span class="o">]</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">          </span><span class="n">provided</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">label</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">input</span><span class="p">.</span><span class="n">review</span><span class="p">.</span><span class="k">object</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">labels</span><span class="o">[</span><span class="n">label</span><span class="o">]</span><span class="err">}</span><span class="w"></span>
<span class="w">          </span><span class="n">required</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">label</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="k">input</span><span class="p">.</span><span class="k">parameters</span><span class="p">.</span><span class="n">labels</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="err">}</span><span class="w"></span>
<span class="w">          </span><span class="n">missing</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">provided</span><span class="w"></span>
<span class="w">          </span><span class="nf">count</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">          </span><span class="n">msg</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="ss">&quot;you must provide labels: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">missing</span><span class="o">]</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="err">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>Above template effectively represents a custom resource definition that
Gatekeeper understands and can enforce via an Webhook registered in the
Kubernetes API server.</p>
<p>Learn more about OPA and Gatekeeper via:</p>
<ul>
<li><a href="https://www.cncf.io/blog/2020/08/13/introducing-policy-as-code-the-open-policy-agent-opa/">Introducing Policy As Code: The Open Policy Agent (OPA)</a></li>
<li><a href="https://blog.openpolicyagent.org/">OPA blog</a></li>
<li><a href="https://academy.styra.com/">Styra Academy</a></li>
<li><a href="https://github.com/raspbernetes/k8s-security-policies">raspbernetes/k8s-security-policies</a></li>
<li><a href="https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/">OPA Gatekeeper: Policy and Governance for Kubernetes</a></li>
<li><a href="https://www.youtube.com/watch?v=v4wJE3I8BYM">CNCF webinar: Kubernetes with OPA Gatekeeper</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../scanning/" title="Scanning" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Scanning
              </span>
            </div>
          </a>
        
        
          <a href="../settings/" title="Secure settings" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Secure settings
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; Liz Rice and Michael Hausenblas
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
      
    
  </body>
</html>